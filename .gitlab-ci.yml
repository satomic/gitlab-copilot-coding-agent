variables:
  UPSTREAM_GITLAB_BASE_URL: "https://gitlab.com"

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "trigger"
    - if: $CI_PIPELINE_SOURCE == "pipeline"
    - when: never

stages:
  - prepare
  - plan
  - implement
  - finalize

# Job for issue assignee workflow
issue_ack:
  stage: prepare
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  script:
    - bash scripts/issue_ack.sh

plan_todo:
  stage: plan
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  needs: [issue_ack]
  image: satomic/copilot-cli:latest
  script:
    - bash scripts/plan_todo.sh
  artifacts:
    paths:
      - todo.md
      - plan_raw.txt
    reports:
      dotenv: plan.env

create_mr:
  stage: plan
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  needs: [plan_todo]
  script:
    - bash scripts/create_mr.sh
  artifacts:
    paths:
      - mr.json
    reports:
      dotenv: mr.env

implement_tasks:
  stage: implement
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  needs:
    - plan_todo
    - create_mr
  image: satomic/copilot-cli:latest
  script:
    - bash scripts/implement_tasks.sh
  artifacts:
    paths:
      - repo-b/todo_completed.md
      - repo-b/patch_raw.txt
      - repo-b/copilot.patch

finalize:
  stage: finalize
  rules:
    - if: $TRIGGER_TYPE == "issue_assignee"
  needs:
    - create_mr
    - implement_tasks
  script:
    - bash scripts/finalize.sh

# Job for MR note workflow
mr_update:
  stage: implement
  rules:
    - if: $TRIGGER_TYPE == "mr_note"
  image: satomic/copilot-cli:latest
  script:
    - bash scripts/mr_update.sh
  artifacts:
    paths:
      - repo-b/patch_raw.txt

# Job for MR reviewer workflow
mr_review:
  stage: implement
  rules:
    - if: $TRIGGER_TYPE == "mr_reviewer"
  image: satomic/copilot-cli:latest
  script:
    - bash scripts/mr_review.sh
  artifacts:
    paths:
      - repo-b/review_raw.txt
      - repo-b/review_summary.txt
